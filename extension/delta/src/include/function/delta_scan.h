#pragma once

#include "connector/connector_factory.h"
#include "connector/delta_connector.h"
#include "connector/duckdb_result_converter.h"
#include "connector/duckdb_type_converter.h"
#include "function/table/call_functions.h"
#include "function/table/scan_functions.h"

namespace kuzu {
namespace delta_extension {

using namespace function;
using namespace common;

struct DeltaScanFunction : function::CallFunction {
    static constexpr const char* name = "DELTA_SCAN";

    static function::function_set getFunctionSet();
};

struct DeltaScanBindData : public ScanBindData {
    std::string query;
    std::shared_ptr<DeltaConnector> connector;
    duckdb_extension::DuckDBResultConverter converter;

    DeltaScanBindData(std::string query, std::shared_ptr<DeltaConnector> connector,
        duckdb_extension::DuckDBResultConverter converter, std::vector<LogicalType> returnTypes,
        std::vector<std::string> returnColumnNames, ReaderConfig config, main::ClientContext* ctx)
        : ScanBindData{std::move(returnTypes), std::move(returnColumnNames), std::move(config),
              ctx},
          query{std::move(query)}, connector{std::move(connector)},
          converter{std::move(converter)} {}
};

// Functions and structs exposed for use
std::unique_ptr<function::TableFuncBindData> bindFuncInternal(main::ClientContext* context,
    function::ScanTableFuncBindInput* input, const std::string& scanFuncName);

std::unique_ptr<TableFuncBindData> bindFunc(main::ClientContext* context,
    ScanTableFuncBindInput* input);

std::unique_ptr<TableFuncSharedState> initDeltaScanSharedState(TableFunctionInitInput& input);

common::offset_t tableFunc(TableFuncInput& input, TableFuncOutput& output);

} // namespace delta_extension
} // namespace kuzu
